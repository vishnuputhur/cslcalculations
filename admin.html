<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Society App - Admin Dashboard</title>
  <style>
    /* Existing styles remain same */
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Dashboard</h1>
    <p id="adminInfo" class="loading">Loading admin data...</p>
    <div class="dashboard-grid" id="dashboardGrid">
      <div class="card">
        <h3>Manage Members</h3>
        <button onclick="showForm('memberForm')">Add Member</button>
        <button onclick="showForm('editMemberForm')">Edit Member</button>
      </div>
      <div class="card">
        <h3>Manage Loans</h3>
        <button onclick="showForm('loanForm')">Add Loan</button>
        <button onclick="showForm('editLoanForm')">Edit Loan</button>
      </div>
      <div class="card">
        <h3>Loan Payments</h3>
        <button onclick="showForm('paymentForm')">Add Payment</button>
      </div>
      <div class="card">
        <h3>Send Message</h3>
        <button onclick="showForm('messageForm')">Send Message</button>
      </div>
      <div class="card">
        <h3>Manage Shares</h3>
        <button onclick="showForm('shareForm')">Add Share</button>
        <button onclick="showForm('editShareForm')">Edit Share</button>
      </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-section">
      <h3>Admin Login</h3>
      <div class="form-group">
        <label>Email:</label><input type="email" id="adminEmail" placeholder="Enter admin email">
      </div>
      <div class="form-group">
        <label>Password:</label><input type="password" id="adminPassword" placeholder="Enter password">
      </div>
      <button onclick="adminLogin()">Login</button>
    </div>

    <!-- Member Form -->
    <div id="memberForm" class="form-section">
      <h3>Add New Member</h3>
      <div class="form-group">
        <label>Email:</label><input type="email" id="memberEmail" placeholder="Enter email">
      </div>
      <div class="form-group">
        <label>Password:</label><input type="password" id="memberPassword" placeholder="Enter password">
      </div>
      <div class="form-group">
        <label>Name:</label><input type="text" id="memberName" placeholder="Enter name">
      </div>
      <div class="form-group">
        <label>Member Number:</label><input type="text" id="memberNumber" placeholder="Enter member number">
      </div>
      <div class="form-group">
        <label>CSL Code:</label><input type="text" id="memberCslCode" placeholder="Enter CSL code">
      </div>
      <div class="form-group">
        <label>Share:</label><input type="text" id="memberShare" placeholder="Enter share">
      </div>
      <div class="form-group">
        <label>Share Amount:</label><input type="number" id="memberShareAmount" placeholder="Enter share amount">
      </div>
      <div class="form-group">
        <label>Address:</label><textarea id="memberAddress" placeholder="Enter address"></textarea>
      </div>
      <div class="form-group">
        <label>Pincode:</label><input type="text" id="memberPincode" placeholder="Enter pincode">
      </div>
      <div class="form-group">
        <label>Phone:</label><input type="text" id="memberPhone" placeholder="Enter phone">
      </div>
      <button onclick="addMember()">Submit</button>
      <div class="instructions">
        <p>Note: Use Firebase Console for bulk adds if rate limits apply.</p>
      </div>
    </div>

    <!-- Edit Member Form -->
    <div id="editMemberForm" class="form-section">
      <h3>Edit Member</h3>
      <div class="form-group">
        <label>User ID:</label><input type="text" id="editMemberId" placeholder="Enter user ID">
      </div>
      <div class="form-group">
        <label>Name:</label><input type="text" id="editMemberName" placeholder="Enter name">
      </div>
      <div class="form-group">
        <label>Address:</label><textarea id="editMemberAddress" placeholder="Enter address"></textarea>
      </div>
      <button onclick="editMember()">Update</button>
    </div>

    <!-- Loan Form -->
    <div id="loanForm" class="form-section">
      <h3>Add New Loan</h3>
      <div class="form-group">
        <label>User ID:</label><input type="text" id="loanUserId" placeholder="Enter user ID">
      </div>
      <div class="form-group">
        <label>Balance:</label><input type="number" id="loanBalance" placeholder="Enter balance">
      </div>
      <div class="form-group">
        <label>Guarantors:</label><input type="text" id="loanGuarantors" placeholder="Enter guarantors (comma-separated)">
      </div>
      <div class="form-group">
        <label>Interest (%):</label><input type="number" id="loanInterest" placeholder="Enter interest">
      </div>
      <div class="form-group">
        <label>Loan Number:</label><input type="text" id="loanNumber" placeholder="Enter loan number">
      </div>
      <div class="form-group">
        <label>Start Date:</label><input type="date" id="loanStartDate">
      </div>
      <button onclick="addLoan()">Submit</button>
    </div>

    <!-- Edit Loan Form -->
    <div id="editLoanForm" class="form-section">
      <h3>Edit Loan</h3>
      <div class="form-group">
        <label>User ID:</label><input type="text" id="editLoanId" placeholder="Enter user ID">
      </div>
      <div class="form-group">
        <label>Balance:</label><input type="number" id="editLoanBalance" placeholder="Enter balance">
      </div>
      <button onclick="editLoan()">Update</button>
    </div>

    <!-- Payment Form -->
    <div id="paymentForm" class="form-section">
      <h3>Add Loan Payment</h3>
      <div class="form-group">
        <label>Loan Number:</label><input type="text" id="paymentLoanNumber" placeholder="Enter loan number">
      </div>
      <div class="form-group">
        <label>Amount:</label><input type="number" id="paymentAmount" placeholder="Enter amount">
      </div>
      <div class="form-group">
        <label>Date:</label><input type="date" id="paymentDate">
      </div>
      <button onclick="addPayment()">Submit</button>
    </div>

    <!-- Other forms remain same -->

    <button id="logoutBtn">Logout</button>
    <p id="error"></p>
    <div id="userList" class="user-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDX_xJLR_FnVg3e_v-e7ZBnaBGAyMVyj1s",
      authDomain: "probanker-2bce7.firebaseapp.com",
      projectId: "probanker-2bce7",
      storageBucket: "probanker-2bce7.firebasestorage.app",
      messagingSenderId: "27106244956",
      appId: "1:27106244956:web:59792c9dc94aa8e5232999",
      measurementId: "G-31138VCDFZ"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.showForm = function(formId) {
        console.log('Showing form:', formId);
        document.querySelectorAll('.form-section').forEach(form => form.classList.remove('active'));
        const form = document.getElementById(formId);
        if (form) {
          form.classList.add('active');
        } else {
          console.error('Form ID not found:', formId);
        }
      };

      onAuthStateChanged(auth, async (user) => {
        const adminInfoEl = document.getElementById('adminInfo');
        const userListEl = document.getElementById('userList');
        const errorEl = document.getElementById('error');
        const loginSection = document.getElementById('loginSection');
        const dashboardGrid = document.getElementById('dashboardGrid');

        if (user) {
          try {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists() && userDoc.data().isAdmin) {
              adminInfoEl.innerText = `Welcome, Admin ${userDoc.data().name}`;
              loginSection.style.display = 'none';
              dashboardGrid.style.display = 'grid';
              const usersSnapshot = await getDocs(collection(db, 'users'));
              let usersHtml = '<h3>Users List</h3>';
              for (const doc of usersSnapshot.docs) {
                const data = doc.data();
                usersHtml += `
                  <div class="user-item" onclick="selectUser('${doc.id}')">
                    User ID: <span id="uid-${doc.id}">${doc.id}</span>
                    <button class="copy-btn" onclick="copyToClipboard('${doc.id}')">Copy</button>
                    | Name: ${data.name || 'N/A'} | Email: ${data.email || 'N/A'} | Member Number: ${data.memberNumber || 'N/A'}
                  </div>
                `;
              }
              userListEl.innerHTML = usersHtml;
            } else {
              adminInfoEl.innerText = 'Access denied: Not an admin';
              errorEl.innerText = 'You are not authorized to access this page!';
              dashboardGrid.style.display = 'none';
              loginSection.classList.add('active');
            }
          } catch (error) {
            errorEl.innerText = 'Error loading admin data: ' + error.message;
            dashboardGrid.style.display = 'none';
            loginSection.classList.add('active');
          }
        } else {
          adminInfoEl.innerText = 'Please log in as admin';
          dashboardGrid.style.display = 'none';
          loginSection.classList.add('active');
        }
      });

      window.adminLogin = async () => {
        const email = document.getElementById('adminEmail').value;
        const password = document.getElementById('adminPassword').value;
        const errorEl = document.getElementById('error');
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          errorEl.innerText = 'Login failed: ' + error.message;
        }
      };

      window.selectUser = function(userId) {
        console.log('Selected user:', userId);
        document.getElementById('editMemberId').value = userId;
        showForm('editMemberForm');
      };

      window.copyToClipboard = function(userId) {
        const uidElement = document.getElementById(`uid-${userId}`);
        navigator.clipboard.writeText(uidElement.innerText).then(() => {
          alert('User ID copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
        });
      };

      window.addMember = async function() {
        const email = document.getElementById('memberEmail').value;
        const password = document.getElementById('memberPassword').value;
        const name = document.getElementById('memberName').value;
        const memberNumber = document.getElementById('memberNumber').value;
        const cslCode = document.getElementById('memberCslCode').value;
        const share = document.getElementById('memberShare').value;
        const shareAmount = document.getElementById('memberShareAmount').value;
        const address = document.getElementById('memberAddress').value;
        const pincode = document.getElementById('memberPincode').value;
        const phone = document.getElementById('memberPhone').value;
        const errorEl = document.getElementById('error');

        console.log('Adding member:', { email, name, memberNumber, cslCode, share, shareAmount, address, pincode, phone });

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;
          console.log('User created with UID:', uid);

          await setDoc(doc(db, 'users', uid), {
            email,
            name,
            memberNumber,
            cslCode,
            share,
            shareAmount: parseFloat(shareAmount) || 0,
            address,
            pincode,
            phone,
            isAdmin: false
          });
          console.log('User data added to Firestore');

          alert('Member added successfully!');
          showForm(null);
        } catch (error) {
          console.error('Add member error:', error);
          errorEl.innerText = 'Error adding member: ' + error.message;
        }
      };

      window.editMember = async function() {
        const userId = document.getElementById('editMemberId').value;
        const name = document.getElementById('editMemberName').value;
        const address = document.getElementById('editMemberAddress').value;
        try {
          await updateDoc(doc(db, 'users', userId), { name, address });
          alert('Member updated successfully!');
          showForm(null);
        } catch (error) {
          document.getElementById('error').innerText = 'Error editing member: ' + error.message;
        }
      };

      window.addLoan = async function() {
        const userId = document.getElementById('loanUserId').value;
        const balance = parseFloat(document.getElementById('loanBalance').value) || 0;
        const guarantors = document.getElementById('loanGuarantors').value.split(',').map(g => g.trim());
        const interest = parseFloat(document.getElementById('loanInterest').value) || 0;
        const loanNumber = document.getElementById('loanNumber').value;
        const startDate = document.getElementById('loanStartDate').value;
        const errorEl = document.getElementById('error');

        try {
          await setDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
            userId,
            balance,
            guarantors,
            interest,
            loanNumber,
            startDate,
            lastUpdated: new Date().toISOString()
          });
          console.log('Loan added successfully');
          alert('Loan added successfully!');
          showForm(null);
        } catch (error) {
          console.error('Add loan error:', error);
          errorEl.innerText = 'Error adding loan: ' + error.message;
        }
      };

      window.editLoan = async function() {
        const userId = document.getElementById('editLoanId').value;
        const balance = parseFloat(document.getElementById('editLoanBalance').value) || 0;
        try {
          await updateDoc(doc(db, 'loans', `${userId}_${loanNumber}`), { balance, lastUpdated: new Date().toISOString() });
          alert('Loan updated successfully!');
          showForm(null);
        } catch (error) {
          document.getElementById('error').innerText = 'Error editing loan: ' + error.message;
        }
      };

      window.addPayment = async function() {
        const loanNumber = document.getElementById('paymentLoanNumber').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
        const date = document.getElementById('paymentDate').value;
        const errorEl = document.getElementById('error');

        try {
          // Fetch loan to update balance
          const loansSnapshot = await getDocs(collection(db, 'loans'));
          let loanDoc;
          for (const doc of loansSnapshot.docs) {
            if (doc.data().loanNumber === loanNumber) {
              loanDoc = doc;
              break;
            }
          }
          if (loanDoc) {
            const newBalance = loanDoc.data().balance - amount;
            await updateDoc(doc(db, 'loans', loanDoc.id), {
              balance: newBalance,
              lastUpdated: new Date().toISOString()
            });
            await setDoc(doc(db, 'payments', `${loanNumber}_${Date.now()}`), {
              loanNumber,
              amount,
              date,
              timestamp: new Date().toISOString()
            });
            console.log('Payment added and balance updated');
            alert('Payment added and balance updated successfully!');
            showForm(null);
          } else {
            throw new Error('Loan number not found');
          }
        } catch (error) {
          console.error('Add payment error:', error);
          errorEl.innerText = 'Error adding payment: ' + error.message;
        }
      };

      // Other form functions remain same

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await signOut(auth);
          window.location.href = 'index.html';
        } catch (error) {
          document.getElementById('error').innerText = 'Error logging out: ' + error.message;
        }
      });
    } catch (error) {
      document.getElementById('error').innerText = 'Firebase init failed: ' + error.message;
    }
  </script>
</body>
</html>