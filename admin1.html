<!DOCTYPE html>
<html lang="ml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Loan Management</title>
  <style>
    /* Keep your existing CSS here - already well written */
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <h1>Admin - Loan Management</h1>
    <p id="adminInfo" class="loading">Loading admin data...</p>

    <!-- Dashboard -->
    <div class="dashboard-grid" id="dashboardGrid">
      <div class="card">
        <h3>Manage Loans</h3>
        <button onclick="showForm('createLoanForm')">Create Loan</button>
        <button onclick="showForm('editLoanForm')">Edit Loan</button>
      </div>
      <div class="card">
        <h3>Loan Repayment</h3>
        <button onclick="showForm('repaymentForm')">Add Repayment</button>
      </div>
    </div>

    <!-- Create Loan Form (Focused part) -->
    <div id="createLoanForm" class="form-section">
      <h3>Create New Loan</h3>

      <div class="form-group">
        <label>Member Number:</label>
        <select id="createMemberNumber">
          <option value="">Select Member</option>
        </select>
        <!-- ðŸ”½ Typing input + Enter Support -->
        <input type="text" id="createMemberSearch" class="search-bar" placeholder="Enter Member Number & press Enter">
        <span id="createUserName" class="user-name"></span>
      </div>

      <!-- Rest of form fields -->
      <div class="form-group">
        <label>Loan Number:</label><input type="text" id="createLoanNumber">
      </div>
      <div class="form-group">
        <label>Loan Amount:</label><input type="number" id="createLoanAmount">
      </div>
      <div class="form-group">
        <label>Interest (%):</label><input type="number" id="createLoanInterest">
      </div>
      <div class="form-group">
        <label>Number of Installments:</label><input type="number" id="createLoanInstallments">
      </div>
      <div class="form-group">
        <label>Loan Start Date:</label><input type="date" id="createLoanStartDate">
      </div>
      <div class="form-group">
        <label>Guarantor 1:</label><input type="text" id="createLoanGuarantor1">
      </div>
      <div class="form-group">
        <label>Guarantor 2:</label><input type="text" id="createLoanGuarantor2">
      </div>

      <button onclick="saveLoan()">Submit</button>
    </div>

    <!-- Error & Popup -->
    <p id="error" style="color:red;"></p>
    <div id="popup" class="popup">This member already has an active loan!</div>
    <div id="popupOverlay" class="popup-overlay"></div>
  </div>

  <!-- Footer -->
  <div class="footer">Powered by VT Soft 2025</div>

  <!-- Firebase SDK Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, getDoc, getDocs, collection, doc, query, where, setDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDX_xJLR_FnVg3e_v-e7ZBnaBGAyMVyj1s",
      authDomain: "probanker-2bce7.firebaseapp.com",
      projectId: "probanker-2bce7",
      storageBucket: "probanker-2bce7.appspot.com",
      messagingSenderId: "27106244956",
      appId: "1:27106244956:web:59792c9dc94aa8e5232999"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Setup persistence
    await setPersistence(auth, browserSessionPersistence);

    // ------------------- ðŸŒŸ Load All Users to Dropdown --------------------
    async function loadUsers() {
      const select = document.getElementById("createMemberNumber");
      select.innerHTML = `<option value="">Select Member</option>`;
      const users = await getDocs(collection(db, 'users'));
      users.forEach(doc => {
        const data = doc.data();
        const text = `${data.memberNumber} - ${data.name || 'No Name'}`;
        const opt = document.createElement("option");
        opt.value = text;
        opt.textContent = text;
        select.appendChild(opt);
      });
    }

    // ------------------- ðŸŒŸ NEW: Enter Search Support --------------------
    document.getElementById('createMemberSearch').addEventListener('keyup', async function (e) {
      if (e.key === 'Enter') {
        const memberNumber = e.target.value.trim();
        const userNameEl = document.getElementById('createUserName');
        const selectEl = document.getElementById('createMemberNumber');
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('popupOverlay');
        const errorEl = document.getElementById('error');

        if (!memberNumber) return;

        try {
          const snapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
          if (snapshot.empty) {
            userNameEl.textContent = '';
            errorEl.textContent = 'Member not found!';
            popup.style.display = 'none';
            overlay.style.display = 'none';
            return;
          }

          const userDoc = snapshot.docs[0];
          const userData = userDoc.data();
          const displayStr = `${userData.memberNumber} - ${userData.name || 'No Name'}`;
          selectEl.value = displayStr;
          userNameEl.textContent = `(${userData.name || 'No Name'})`;
          errorEl.textContent = '';

          const loans = await getDocs(query(collection(db, 'loans'), where('userId', '==', userDoc.id)));
          if (!loans.empty) {
            popup.style.display = 'block';
            overlay.style.display = 'block';
          } else {
            popup.style.display = 'none';
            overlay.style.display = 'none';
          }

        } catch (err) {
          console.error('Search error:', err);
          errorEl.textContent = 'Error searching member.';
        }
      }
    });

    // Overlay dismiss action
    document.getElementById('popupOverlay').addEventListener('click', () => {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('popupOverlay').style.display = 'none';
    });

    // ------------------- ðŸŒŸ Auth State Handling --------------------
    onAuthStateChanged(auth, async (user) => {
      const info = document.getElementById('adminInfo');
      const dashboard = document.getElementById('dashboardGrid');

      if (user) {
        const profile = await getDoc(doc(db, 'users', user.uid));
        if (profile.exists() && profile.data().isAdmin) {
          info.textContent = `Welcome Admin ${profile.data().name || ''}`;
          dashboard.style.display = 'grid';
          loadUsers();
        } else {
          info.textContent = 'Access denied';
        }
      } else {
        info.textContent = 'Please login';
      }
    });

    // ------------------- ðŸŒŸ Create Loan Logic --------------------
    window.saveLoan = async function () {
      const select = document.getElementById('createMemberNumber').value;
      const [memberNumber] = select.split(' - ');
      const loanNumber = document.getElementById('createLoanNumber').value;
      const amount = parseFloat(document.getElementById('createLoanAmount').value);
      const interest = parseFloat(document.getElementById('createLoanInterest').value);
      const installments = parseInt(document.getElementById('createLoanInstallments').value);
      const startDate = document.getElementById('createLoanStartDate').value;
      const g1 = document.getElementById('createLoanGuarantor1').value;
      const g2 = document.getElementById('createLoanGuarantor2').value;
      const errorEl = document.getElementById('error');

      if (!memberNumber || !loanNumber || !amount || !interest || !installments || !startDate || !g1 || !g2) {
        errorEl.textContent = 'Please fill all fields.';
        return;
      }

      const userDocs = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (userDocs.empty) {
        errorEl.textContent = 'User not found!';
        return;
      }

      const userId = userDocs.docs[0].id;
      const loanRef = doc(db, 'loans', `${userId}_${loanNumber}`);
      await setDoc(loanRef, {
        userId,
        loanNumber,
        amount,
        interest,
        installments,
        startDate,
        guarantors: [g1, g2],
        balance: amount,
        interestDue: 0,
        createdAt: new Date().toISOString()
      });

      errorEl.textContent = '';
      alert('Loan created successfully!');
      document.getElementById('createLoanForm').reset?.();
    }

  </script>
</body>
</html>
