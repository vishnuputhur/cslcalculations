<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Admin - Loan Management</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f8ff, #e6f3fa);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #2c3e50;
    }
    .container {
      flex: 1;
      padding: 15px;
      max-width: 100%;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #1a252f;
      font-size: 20px;
      margin: 15px 0;
      font-weight: 600;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card h3 {
      color: #1a252f;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .card button {
      width: 70%;
      padding: 4px;
      margin: 2px 0;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .card button:hover {
      background: #2980b9;
    }
    .form-section, .login-section {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9fbfd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .form-section.active, .login-section.active {
      display: block;
    }
    .form-group {
      margin-bottom: 12px;
      text-align: left;
    }
    .form-group label {
      display: block;
      color: #1a252f;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input {
      width: 220px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
    }
    .form-group .user-info {
      display: block;
      margin-top: 5px;
      color: #1a252f;
      font-size: 13px;
    }
    #error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
    }
    #logoutBtn {
      width: 70%;
      padding: 4px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      margin: 15px auto;
      display: block;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }
    .loan-list, .payment-list {
      margin-top: 15px;
    }
    .loan-table, .payment-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .loan-table th, .loan-table td, .payment-table th, .payment-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .loan-table th, .payment-table th {
      background: #3498db;
      color: #fff;
      font-size: 13px;
    }
    .loan-table td, .payment-table td {
      font-size: 12px;
    }
    .loan-table tr:hover, .payment-table tr:hover {
      background: #f5f6fa;
    }
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #1a252f;
      color: #fff;
      text-align: center;
      padding: 5px 0;
      font-size: 11px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    @media (min-width: 768px) {
      h1 { font-size: 26px; }
      .card button { font-size: 13px; padding: 6px; }
      .form-group label { font-size: 14px; }
      .form-group input { font-size: 14px; padding: 8px; }
      .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .loan-table th, .loan-table td, .payment-table th, .payment-table td { font-size: 14px; padding: 10px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Admin - Loan Management</h1>
  <p id="adminInfo" class="loading">Loading admin data...</p>

  <div class="dashboard-grid" id="dashboardGrid">
    <div class="card">
      <h3>Manage Loans</h3>
      <button onclick="showForm('createLoanForm')">Create Loan</button>
      <button onclick="showForm('editLoanForm')">Edit Loan</button>
    </div>
    <div class="card">
      <h3>Loan Repayment</h3>
      <button onclick="showForm('repaymentForm')">Add Repayment</button>
    </div>
    <div class="card">
      <h3>Back to Dashboard</h3>
      <button onclick="window.location.href='admin.html'">Go to User Management</button>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="login-section">
    <h3>Admin Login</h3>
    <div class="form-group">
      <label>Email:</label><input type="email" id="adminEmail" placeholder="Enter admin email">
    </div>
    <div class="form-group">
      <label>Password:</label><input type="password" id="adminPassword" placeholder="Enter password">
    </div>
    <button onclick="adminLogin()">Login</button>
  </div>

  <!-- Create Loan Form -->
  <div id="createLoanForm" class="form-section">
    <h3>Create New Loan</h3>
    <div class="form-group">
      <label>Member Number:</label><input type="text" id="createMemberNumber" oninput="updateUserInfo('create')">
    </div>
    <div class="form-group">
      <span id="createUserInfo" class="user-info"></span>
    </div>
    <div class="form-group">
      <label>Loan Number:</label><input type="text" id="createLoanNumber" placeholder="Enter loan number">
    </div>
    <div class="form-group">
      <label>Loan Amount:</label><input type="number" id="createLoanAmount" placeholder="Enter loan amount">
    </div>
    <div class="form-group">
      <label>Interest (%):</label><input type="number" id="createLoanInterest" placeholder="Enter interest rate">
    </div>
    <div class="form-group">
      <label>Number of Installments:</label><input type="number" id="createLoanInstallments" placeholder="Enter number of installments">
    </div>
    <div class="form-group">
      <label>Loan Start Date:</label><input type="date" id="createLoanStartDate" value="">
    </div>
    <div class="form-group">
      <label>Guarantor 1:</label><input type="text" id="createLoanGuarantor1" placeholder="Enter guarantor name">
    </div>
    <div class="form-group">
      <label>Guarantor 2:</label><input type="text" id="createLoanGuarantor2" placeholder="Enter guarantor name">
    </div>
    <button onclick="saveLoan()">Submit</button>
  </div>

  <!-- Edit Loan Form -->
  <div id="editLoanForm" class="form-section">
    <h3>Edit Loan</h3>
    <div class="form-group">
      <label>Member Number:</label><input type="text" id="editMemberNumber" oninput="updateUserInfo('edit')">
    </div>
    <div class="form-group">
      <span id="editUserInfo" class="user-info"></span>
    </div>
    <div class="form-group">
      <label>Loan Number:</label><input type="text" id="editLoanNumber" oninput="loadLoanDetails('edit')">
    </div>
    <div class="form-group">
      <label>Outstanding Principal:</label><input type="number" id="editLoanPrincipal" placeholder="Enter outstanding principal">
    </div>
    <div class="form-group">
      <label>Interest Due:</label><input type="number" id="editLoanInterestDue" placeholder="Enter interest due">
    </div>
    <div class="form-group">
      <label>Interest (%):</label><input type="number" id="editLoanInterest" placeholder="Enter interest rate">
    </div>
    <div class="form-group">
      <label>Guarantor 1:</label><input type="text" id="editLoanGuarantor1" placeholder="Enter guarantor name">
    </div>
    <div class="form-group">
      <label>Guarantor 2:</label><input type="text" id="editLoanGuarantor2" placeholder="Enter guarantor name">
    </div>
    <button onclick="updateLoan()">Update</button>
  </div>

  <!-- Repayment Entry Form -->
  <div id="repaymentForm" class="form-section active">
    <h3>Add Loan Repayment</h3>
    <div class="form-group">
      <label>Member Number:</label><input type="text" id="repayMemberNumber" oninput="updateRepaymentInfo()">
    </div>
    <div class="form-group">
      <span id="repayUserInfo" class="user-info"></span>
    </div>
    <div class="form-group">
      <label>Loan Number:</label><input type="text" id="repayLoanNumber">
    </div>
    <div class="form-group">
      <label>Next Principal:</label><input type="number" id="repayPrincipal">
    </div>
    <div class="form-group">
      <label>Interest (Last Payment to Today):</label><input type="number" id="repayInterest">
    </div>
    <div class="form-group">
      <label>Last Balance:</label><input type="number" id="repayLastBalance">
    </div>
    <div class="form-group">
      <label>Entry Date:</label><input type="date" id="repayDate" onchange="calculateInterest()">
    </div>
    <div class="form-group">
      <label>Principal Paid:</label><input type="number" id="repayPrincipalPaid" oninput="updateNewBalance()">
    </div>
    <div class="form-group">
      <label>Interest Paid:</label><input type="number" id="repayInterestPaid" oninput="updateNewBalance()">
    </div>
    <div class="form-group">
      <label>New Outstanding Balance:</label><input type="number" id="repayNewBalance">
    </div>
    <div class="form-group">
      <label>Interest Due:</label><input type="number" id="repayInterestDue">
    </div>
    <div class="form-group">
      <label>Receipt Number:</label><input type="text" id="repayReceiptNumber" placeholder="Enter receipt number">
    </div>
    <button onclick="addRepayment()">Submit</button>
    <div class="payment-list" id="paymentList"></div>
  </div>

  <button id="logoutBtn">Logout</button>
  <p id="error"></p>
  <div id="popup" class="popup" style="display: none;">This member already has an active loan!</div>
  <div id="popupOverlay" class="popup-overlay" style="display: none;"></div>
</div>

<div class="footer">Powered by VT Soft 2025</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDX_xJLR_FnVg3e_v-e7ZBnaBGAyMVyj1s",
    authDomain: "probanker-2bce7.firebaseapp.com",
    projectId: "probanker-2bce7",
    storageBucket: "probanker-2bce7.appspot.com",
    messagingSenderId: "27106244956",
    appId: "1:27106244956:web:59792c9dc94aa8e5232999",
    measurementId: "G-31138VCDFZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  setPersistence(auth, browserSessionPersistence)
    .then(() => console.log('Persistence set to session'))
    .catch((error) => console.error('Error setting persistence:', error));

  // Set today's date as default in repayment form
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('repayDate').value = today;
  });

  window.showForm = function(formId) {
    document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
    if (formId) document.getElementById(formId).classList.add('active');
    if (formId === 'repaymentForm') {
      document.getElementById('repayDate').value = new Date().toISOString().split('T')[0];
      calculateInterest();
    }
  };

  onAuthStateChanged(auth, async (user) => {
    const adminInfoEl = document.getElementById('adminInfo');
    const errorEl = document.getElementById('error');
    const loginSection = document.getElementById('loginSection');
    const dashboardGrid = document.getElementById('dashboardGrid');

    if (user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().isAdmin) {
          adminInfoEl.innerText = `Welcome, Admin ${userDoc.data().name || 'Admin'}`;
          loginSection.style.display = 'none';
          dashboardGrid.style.display = 'grid';
        } else {
          adminInfoEl.innerText = 'Access denied: Not an admin';
          errorEl.innerText = 'You are not authorized to access this page!';
          dashboardGrid.style.display = 'none';
          loginSection.classList.add('active');
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
        errorEl.innerText = 'Error loading admin data: ' + error.message;
        dashboardGrid.style.display = 'none';
        loginSection.classList.add('active');
      }
    } else {
      adminInfoEl.innerText = 'Please log in as admin';
      dashboardGrid.style.display = 'none';
      loginSection.classList.add('active');
    }
  });

  window.adminLogin = async () => {
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('error');
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      errorEl.innerText = 'Login failed: ' + error.message;
    }
  };

  window.updateUserInfo = async function(type) {
    const memberNumber = document.getElementById(`${type}MemberNumber`).value;
    const userInfoEl = document.getElementById(`${type}UserInfo`);
    if (memberNumber) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const name = userDoc.data().name || 'No Name';
          userInfoEl.textContent = `Name: ${name}`;
        } else {
          userInfoEl.textContent = 'User not found';
        }
      } catch (error) {
        userInfoEl.textContent = 'Error fetching user info';
        console.error('Error fetching user info:', error);
        document.getElementById('error').innerText = 'Error fetching user info: ' + error.message;
      }
    } else {
      userInfoEl.textContent = '';
    }
  };

  async function loadLoanDetails(type) {
    const loanNumber = document.getElementById(`${type}LoanNumber`).value;
    const memberNumber = document.getElementById(`${type}MemberNumber`).value;
    if (loanNumber && memberNumber) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const loanDoc = await getDoc(doc(db, 'loans', `${userId}_${loanNumber}`));
          if (loanDoc.exists()) {
            const data = loanDoc.data();
            if (type === 'edit') {
              document.getElementById('editLoanPrincipal').value = data.balance || 0;
              document.getElementById('editLoanInterestDue').value = data.interestDue || 0;
              document.getElementById('editLoanInterest').value = data.interest || 0;
              document.getElementById('editLoanGuarantor1').value = data.guarantors[0] || '';
              document.getElementById('editLoanGuarantor2').value = data.guarantors[1] || '';
            }
          }
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Error loading loan details: ' + error.message;
      }
    }
  }

  window.saveLoan = async function() {
    const memberNumber = document.getElementById('createMemberNumber').value;
    const loanNumber = document.getElementById('createLoanNumber').value;
    const amount = parseFloat(document.getElementById('createLoanAmount').value) || 0;
    const interest = parseFloat(document.getElementById('createLoanInterest').value) || 0;
    const installments = parseInt(document.getElementById('createLoanInstallments').value) || 0;
    const startDate = document.getElementById('createLoanStartDate').value;
    const guarantor1 = document.getElementById('createLoanGuarantor1').value;
    const guarantor2 = document.getElementById('createLoanGuarantor2').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    if (!memberNumber || !loanNumber || !amount || !interest || !installments || !startDate || !guarantor1 || !guarantor2) {
      errorEl.innerText = 'All fields are required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        await setDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
          userId, loanNumber, amount, balance: amount, interest, installments, startDate,
          guarantors: [guarantor1, guarantor2], lastUpdated: new Date().toISOString()
        });
        alert('Loan created successfully!');
        showForm(null);
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error creating loan: ' + error.message;
    }
  };

  window.updateLoan = async function() {
    const memberNumber = document.getElementById('editMemberNumber').value;
    const loanNumber = document.getElementById('editLoanNumber').value;
    const principal = parseFloat(document.getElementById('editLoanPrincipal').value) || 0;
    const interestDue = parseFloat(document.getElementById('editLoanInterestDue').value) || 0;
    const interest = parseFloat(document.getElementById('editLoanInterest').value) || 0;
    const guarantor1 = document.getElementById('editLoanGuarantor1').value;
    const guarantor2 = document.getElementById('editLoanGuarantor2').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        await updateDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
          balance: principal, interestDue, interest, guarantors: [guarantor1, guarantor2], lastUpdated: new Date().toISOString()
        });
        alert('Loan updated successfully!');
        showForm(null);
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error updating loan: ' + error.message;
    }
  };

  // Enhanced repayment functions
  window.updateRepaymentInfo = async function() {
    const memberNumber = document.getElementById('repayMemberNumber').value;
    const userInfoEl = document.getElementById('repayUserInfo');
    const loanNumberEl = document.getElementById('repayLoanNumber');
    const principalEl = document.getElementById('repayPrincipal');
    const interestEl = document.getElementById('repayInterest');
    const lastBalanceEl = document.getElementById('repayLastBalance');
    const repayDateEl = document.getElementById('repayDate');
    const paymentListEl = document.getElementById('paymentList');

    if (memberNumber) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const name = userDoc.data().name || 'No Name';
          userInfoEl.textContent = `Name: ${name}`;

          // Get active loan for this user with specific loan number if entered
          let loansSnapshot;
          if (loanNumberEl.value) {
            loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId), where('loanNumber', '==', loanNumberEl.value)));
          } else {
            loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId)));
          }
          if (!loansSnapshot.empty) {
            const loanDoc = loansSnapshot.docs[0]; // Use first loan if multiple
            const loanData = loanDoc.data();
            const loanId = loanDoc.id.split('_')[1];

            // Validate required loan data
            if (loanData && loanData.amount && loanData.startDate && loanData.interest && loanData.balance !== undefined) {
              // Auto-fill loan details
              loanNumberEl.value = loanId || '';
              lastBalanceEl.value = loanData.balance.toFixed(2);

              // Calculate principal installment
              const principalInstallment = loanData.installments ? (loanData.amount / loanData.installments).toFixed(2) : '0.00';
              principalEl.value = principalInstallment;

              // Get last payment date or use loan start date
              const lastPaymentDate = await getLastPaymentDate(userId, loanId);
              const startDate = lastPaymentDate ? new Date(lastPaymentDate) : new Date(loanData.startDate);
              const today = new Date();

              // Calculate days difference
              const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));

              // Calculate interest
              const interestAmount = (loanData.balance * loanData.interest * daysDiff) / (100 * 365);
              interestEl.value = interestAmount.toFixed(2);

              // Set today's date
              repayDateEl.value = today.toISOString().split('T')[0];

              // Update payment list
              paymentListEl.innerHTML = await generatePaymentStatement(userId, loanId);

              // Calculate new balance and interest due
              calculateInterest();
            } else {
              loanNumberEl.value = loanId || '';
              principalEl.value = '0.00';
              interestEl.value = '0.00';
              lastBalanceEl.value = loanData.balance ? loanData.balance.toFixed(2) : '0.00';
              paymentListEl.innerHTML = '<p>Incomplete loan data. Please ensure amount, start date, interest, and balance are set.</p>';
            }
          } else {
            loanNumberEl.value = '';
            principalEl.value = '';
            interestEl.value = '';
            lastBalanceEl.value = '';
            paymentListEl.innerHTML = '<p>No loans found for this member.</p>';
          }
        } else {
          userInfoEl.textContent = 'User not found';
          loanNumberEl.value = '';
          principalEl.value = '';
          interestEl.value = '';
          lastBalanceEl.value = '';
          paymentListEl.innerHTML = '';
        }
      } catch (error) {
        userInfoEl.textContent = 'Error fetching user info';
        console.error('Error fetching repayment info:', error);
        document.getElementById('error').innerText = 'Error fetching user info: ' + error.message;
        if (error.code === 'permission-denied') {
          document.getElementById('error').innerText += ' (Check Firebase security rules or permissions)';
        } else if (error.code === 'unavailable') {
          document.getElementById('error').innerText += ' (Network issue, check your connection)';
        }
        loanNumberEl.value = '';
        principalEl.value = '';
        interestEl.value = '';
        lastBalanceEl.value = '';
        paymentListEl.innerHTML = '';
      }
    } else {
      userInfoEl.textContent = '';
      loanNumberEl.value = '';
      principalEl.value = '';
      interestEl.value = '';
      lastBalanceEl.value = '';
      paymentListEl.innerHTML = '';
    }
  };

  window.calculateInterest = async function() {
    const memberNumber = document.getElementById('repayMemberNumber').value;
    const repayDate = document.getElementById('repayDate').value;
    const principalPaid = parseFloat(document.getElementById('repayPrincipalPaid').value) || 0;
    const interestPaid = parseFloat(document.getElementById('repayInterestPaid').value) || 0;
    const newBalanceEl = document.getElementById('repayNewBalance');
    const interestDueEl = document.getElementById('repayInterestDue');
    const lastBalanceEl = document.getElementById('repayLastBalance');

    if (memberNumber && repayDate) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const loanNumber = document.getElementById('repayLoanNumber').value;
          let loansSnapshot;
          if (loanNumber) {
            loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId), where('loanNumber', '==', loanNumber)));
          } else {
            loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId)));
          }
          if (!loansSnapshot.empty) {
            const loanDoc = loansSnapshot.docs[0];
            const loanData = loanDoc.data();
            const loanId = loanDoc.id.split('_')[1];
            const lastPaymentDate = await getLastPaymentDate(userId, loanId);

            // Calculate days difference
            const startDate = lastPaymentDate ? new Date(lastPaymentDate) : new Date(loanData.startDate);
            const endDate = new Date(repayDate);
            const daysDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));

            // Calculate interest
            const interestDue = loanData.interest && loanData.balance ? (loanData.balance * loanData.interest * daysDiff) / (100 * 365) : 0;
            const lastBalance = parseFloat(lastBalanceEl.value) || loanData.balance || 0;

            // Update fields
            interestDueEl.value = interestDue.toFixed(2);
            newBalanceEl.value = (lastBalance - principalPaid).toFixed(2);
          }
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Error calculating interest: ' + error.message;
      }
    }
  };

  window.updateNewBalance = function() {
    const principalPaid = parseFloat(document.getElementById('repayPrincipalPaid').value) || 0;
    const interestPaid = parseFloat(document.getElementById('repayInterestPaid').value) || 0;
    const lastBalance = parseFloat(document.getElementById('repayLastBalance').value) || 0;
    const newBalanceEl = document.getElementById('repayNewBalance');

    newBalanceEl.value = (lastBalance - principalPaid).toFixed(2);
  };

  async function getLastPaymentDate(userId, loanNumber) {
    const paymentsSnapshot = await getDocs(query(collection(db, 'payments'),
      where('userId', '==', userId),
      where('loanNumber', '==', loanNumber),
      orderBy('timestamp', 'desc'),
      limit(1)));

    if (!paymentsSnapshot.empty) {
      return paymentsSnapshot.docs[0].data().timestamp;
    }
    return null;
  }

  async function generatePaymentStatement(userId, loanNumber) {
    const paymentsSnapshot = await getDocs(query(collection(db, 'payments'),
      where('userId', '==', userId),
      where('loanNumber', '==', loanNumber),
      orderBy('timestamp', 'desc')));

    let payments = [];
    paymentsSnapshot.forEach(doc => {
      payments.push({ id: doc.id, ...doc.data() });
    });

    let tableHtml = '<h3>Last Transactions</h3><table class="payment-table"><thead><tr><th>Date</th><th>Principal Paid</th><th>Interest Paid</th><th>New Balance</th><th>Receipt #</th></tr></thead><tbody>';

    if (payments.length === 0) {
      tableHtml += '<tr><td colspan="5">No transactions found.</td></tr>';
    } else {
      payments.forEach(payment => {
        const paymentDate = payment.date ? new Date(payment.date) : new Date(payment.timestamp);
        const formattedDate = paymentDate.toLocaleDateString('en-IN');
        tableHtml += `
          <tr>
            <td>${formattedDate}</td>
            <td>₹${payment.principal?.toFixed(2) || '0.00'}</td>
            <td>₹${payment.interest?.toFixed(2) || '0.00'}</td>
            <td>₹${payment.newBalance?.toFixed(2) || '0.00'}</td>
            <td>${payment.receiptNumber || 'N/A'}</td>
          </tr>
        `;
      });
    }
    tableHtml += '</tbody></table>';
    return tableHtml;
  }

  window.addRepayment = async function() {
    const memberNumber = document.getElementById('repayMemberNumber').value;
    const loanNumber = document.getElementById('repayLoanNumber').value;
    const date = document.getElementById('repayDate').value;
    const principalPaid = parseFloat(document.getElementById('repayPrincipalPaid').value) || 0;
    const interestPaid = parseFloat(document.getElementById('repayInterestPaid').value) || 0;
    const newBalance = parseFloat(document.getElementById('repayNewBalance').value) || 0;
    const interestDue = parseFloat(document.getElementById('repayInterestDue').value) || 0;
    const receiptNumber = document.getElementById('repayReceiptNumber').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    if (!date || (!principalPaid && !interestPaid)) {
      errorEl.innerText = 'Date and at least one payment amount is required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        const loanDoc = await getDoc(doc(db, 'loans', `${userId}_${loanNumber}`));

        if (loanDoc.exists()) {
          // Update loan with new balance and reset interest due
          await updateDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
            balance: newBalance,
            interestDue: 0,
            lastUpdated: new Date().toISOString()
          });

          // Add payment record
          await setDoc(doc(db, 'payments', `${userId}_${loanNumber}_${Date.now()}`), {
            userId,
            loanNumber,
            date,
            principal: principalPaid,
            interest: interestPaid,
            newBalance,
            interestDue,
            receiptNumber,
            timestamp: new Date().toISOString()
          });

          alert('Repayment added successfully!');
          showForm(null);
          updateRepaymentInfo(); // Refresh form and table
        } else {
          errorEl.innerText = 'Loan not found!';
        }
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error adding repayment: ' + error.message;
      console.error('Repayment error:', error);
    }
  };

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await signOut(auth);
      window.location.href = 'index.html';
    } catch (error) {
      document.getElementById('error').innerText = 'Error logging out: ' + error.message;
    }
  });
</script>
</body>
</html>