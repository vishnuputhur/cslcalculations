<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Admin - Loan Management</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f8ff, #e6f3fa);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #2c3e50;
    }
    .container {
      flex: 1;
      padding: 15px;
      max-width: 100%;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #1a252f;
      font-size: 20px;
      margin: 15px 0;
      font-weight: 600;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card h3 {
      color: #1a252f;
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .card button {
      width: 70%;
      padding: 4px;
      margin: 2px 0;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .card button:hover {
      background: #2980b9;
    }
    .form-section, .login-section {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9fbfd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .form-section.active, .login-section.active {
      display: block;
    }
    .form-group {
      margin-bottom: 12px;
      text-align: left;
    }
    .form-group label {
      display: block;
      color: #1a252f;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 13px;
      box-sizing: border-box;
      background: #fff;
    }
    #error {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 10px;
      text-align: center;
    }
    #logoutBtn {
      width: 70%;
      padding: 4px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      margin: 15px auto;
      display: block;
    }
    #logoutBtn:hover {
      background: #c0392b;
    }
    .loan-list, .payment-list {
      margin-top: 15px;
    }
    .loan-table, .payment-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .loan-table th, .loan-table td, .payment-table th, .payment-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .loan-table th, .payment-table th {
      background: #3498db;
      color: #fff;
      font-size: 13px;
    }
    .loan-table td, .payment-table td {
      font-size: 12px;
    }
    .loan-table tr:hover, .payment-table tr:hover {
      background: #f5f6fa;
    }
    .select-btn {
      margin-left: 5px;
      background: #2ecc71;
      padding: 2px 4px;
      border: none;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
    }
    .select-btn:hover {
      background: #27ae60;
    }
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #1a252f;
      color: #fff;
      text-align: center;
      padding: 5px 0;
      font-size: 11px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    @media (min-width: 768px) {
      h1 { font-size: 26px; }
      .card button { font-size: 13px; padding: 6px; }
      .form-group label { font-size: 14px; }
      .form-group input, .form-group textarea, .form-group select { font-size: 14px; padding: 8px; }
      .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      .loan-table th, .loan-table td, .payment-table th, .payment-table td { font-size: 14px; padding: 10px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Admin - Loan Management</h1>
  <p id="adminInfo" class="loading">Loading admin data...</p>

  <div class="dashboard-grid" id="dashboardGrid">
    <div class="card">
      <h3>Manage Loans</h3>
      <button onclick="showForm('createLoanForm')">Create Loan</button>
      <button onclick="showForm('editLoanForm')">Edit Loan</button>
    </div>
    <div class="card">
      <h3>Loan Repayment</h3>
      <button onclick="showForm('repaymentForm')">Add Repayment</button>
    </div>
    <div class="card">
      <h3>Back to Dashboard</h3>
      <button onclick="window.location.href='admin.html'">Go to User Management</button>
    </div>
  </div>

  <!-- Login Section -->
  <div id="loginSection" class="login-section">
    <h3>Admin Login</h3>
    <div class="form-group">
      <label>Email:</label><input type="email" id="adminEmail" placeholder="Enter admin email">
    </div>
    <div class="form-group">
      <label>Password:</label><input type="password" id="adminPassword" placeholder="Enter password">
    </div>
    <button onclick="adminLogin()">Login</button>
  </div>

  <!-- Create Loan Form -->
  <div id="createLoanForm" class="form-section">
    <h3>Create New Loan</h3>
    <div class="form-group">
      <label>Member Number:</label>
      <input type="text" id="createMemberNumber" placeholder="Enter Member Number" oninput="fetchUserDetails('create')">
    </div>
    <div class="form-group">
      <label>Loan Number:</label><input type="text" id="createLoanNumber" placeholder="Enter loan number">
    </div>
    <div class="form-group">
      <label>Loan Amount:</label><input type="number" id="createLoanAmount" placeholder="Enter loan amount">
    </div>
    <div class="form-group">
      <label>Interest (%):</label><input type="number" id="createLoanInterest" placeholder="Enter interest rate">
    </div>
    <div class="form-group">
      <label>Number of Installments:</label><input type="number" id="createLoanInstallments" placeholder="Enter number of installments">
    </div>
    <div class="form-group">
      <label>Loan Start Date:</label><input type="date" id="createLoanStartDate" value="">
    </div>
    <div class="form-group">
      <label>Guarantor 1:</label><input type="text" id="createLoanGuarantor1" placeholder="Enter guarantor name">
    </div>
    <div class="form-group">
      <label>Guarantor 2:</label><input type="text" id="createLoanGuarantor2" placeholder="Enter guarantor name">
    </div>
    <button onclick="saveLoan()">Submit</button>
  </div>

  <!-- Edit Loan Form -->
  <div id="editLoanForm" class="form-section">
    <h3>Edit Loan</h3>
    <div class="form-group">
      <label>Member Number:</label>
      <input type="text" id="editMemberNumber" placeholder="Enter Member Number" oninput="fetchUserDetails('edit')">
    </div>
    <div class="form-group">
      <label>Loan Number:</label><input type="text" id="editLoanNumber" readonly>
    </div>
    <div class="form-group">
      <label>Outstanding Principal:</label><input type="number" id="editLoanPrincipal" placeholder="Enter outstanding principal">
    </div>
    <div class="form-group">
      <label>Interest Due:</label><input type="number" id="editLoanInterestDue" placeholder="Enter interest due">
    </div>
    <div class="form-group">
      <label>Interest (%):</label><input type="number" id="editLoanInterest" placeholder="Enter interest rate">
    </div>
    <div class="form-group">
      <label>Guarantor 1:</label><input type="text" id="editLoanGuarantor1" placeholder="Enter guarantor name">
    </div>
    <div class="form-group">
      <label>Guarantor 2:</label><input type="text" id="editLoanGuarantor2" placeholder="Enter guarantor name">
    </div>
    <button onclick="updateLoan()">Update</button>
  </div>

  <!-- Repayment Entry Form -->
  <div id="repaymentForm" class="form-section">
    <h3>Add Loan Repayment</h3>
    <div class="form-group">
      <label>Member Number:</label>
      <input type="text" id="repayMemberNumber" placeholder="Enter Member Number" oninput="fetchUserDetails('repay')">
    </div>
    <div class="form-group">
      <label>Loan Number:</label>
      <select id="repayLoanNumber" onchange="loadLoanDetails()">
        <option value="">Select Loan Number</option>
      </select>
    </div>
    <div class="form-group">
      <label>Entry Date:</label><input type="date" id="repayDate" value="" oninput="calculateInterest()">
    </div>
    <div class="form-group">
      <label>Principal Paid:</label><input type="number" id="repayPrincipal" placeholder="Enter principal paid">
    </div>
    <div class="form-group">
      <label>Interest Paid:</label><input type="number" id="repayInterest" placeholder="Enter interest paid">
    </div>
    <div class="form-group">
      <label>New Outstanding Balance:</label><input type="number" id="repayNewBalance" readonly>
    </div>
    <div class="form-group">
      <label>Interest Due:</label><input type="number" id="repayInterestDue" readonly>
    </div>
    <div class="form-group">
      <label>Receipt Number:</label><input type="text" id="repayReceiptNumber" placeholder="Enter receipt number">
    </div>
    <button onclick="addRepayment()">Submit</button>
  </div>

  <div class="loan-list" id="loanList"></div>
  <div class="payment-list" id="paymentList"></div>

  <button id="logoutBtn">Logout</button>
  <p id="error"></p>
</div>

<div class="footer">Powered by VT Soft 2025</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDX_xJLR_FnVg3e_v-e7ZBnaBGAyMVyj1s",
    authDomain: "probanker-2bce7.firebaseapp.com",
    projectId: "probanker-2bce7",
    storageBucket: "probanker-2bce7.firebasestorage.app",
    messagingSenderId: "27106244956",
    appId: "1:27106244956:web:59792c9dc94aa8e5232999",
    measurementId: "G-31138VCDFZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  setPersistence(auth, browserSessionPersistence)
    .then(() => console.log('Persistence set to session'))
    .catch((error) => console.error('Error setting persistence:', error));

  window.showForm = function(formId) {
    document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
    if (formId) document.getElementById(formId).classList.add('active');
    if (formId === 'repaymentForm') {
      document.getElementById('repayDate').value = new Date().toISOString().split('T')[0];
      calculateInterest();
    }
  };

  onAuthStateChanged(auth, async (user) => {
    const adminInfoEl = document.getElementById('adminInfo');
    const errorEl = document.getElementById('error');
    const loginSection = document.getElementById('loginSection');
    const dashboardGrid = document.getElementById('dashboardGrid');

    if (user) {
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().isAdmin) {
          adminInfoEl.innerText = `Welcome, Admin ${userDoc.data().name || 'Admin'}`;
          loginSection.style.display = 'none';
          dashboardGrid.style.display = 'grid';
        } else {
          adminInfoEl.innerText = 'Access denied: Not an admin';
          errorEl.innerText = 'You are not authorized to access this page!';
          dashboardGrid.style.display = 'none';
          loginSection.classList.add('active');
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
        errorEl.innerText = 'Error loading admin data: ' + error.message;
        dashboardGrid.style.display = 'none';
        loginSection.classList.add('active');
      }
    } else {
      adminInfoEl.innerText = 'Please log in as admin';
      dashboardGrid.style.display = 'none';
      loginSection.classList.add('active');
    }
  });

  window.adminLogin = async () => {
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('error');
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      errorEl.innerText = 'Login failed: ' + error.message;
    }
  };

  async function fetchUserDetails(type) {
    const memberNumber = document.getElementById(`${type}MemberNumber`).value;
    const errorEl = document.getElementById('error');
    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const data = userDoc.data();
        if (type === 'create') {
          document.getElementById('createLoanNumber').value = ''; // Clear loan number on new user
        } else if (type === 'edit') {
          await loadUserLoans('edit');
        } else if (type === 'repay') {
          await loadUserLoans('repay');
        }
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error fetching user details: ' + error.message;
    }
  }

  async function loadUserLoans(type = '') {
    const memberNumber = type === 'edit' ? document.getElementById('editMemberNumber').value : document.getElementById('repayMemberNumber').value;
    const loanListEl = document.getElementById('loanList');
    const repayLoanNumber = document.getElementById('repayLoanNumber');
    if (memberNumber) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId)));
          let tableHtml = '<h3>Existing Loans</h3><table class="loan-table"><thead><tr><th>Loan Number</th><th>Amount</th><th>Balance</th><th>Action</th></tr></thead><tbody>';
          repayLoanNumber.innerHTML = '<option value="">Select Loan Number</option>';
          if (loansSnapshot.empty) {
            tableHtml += '<tr><td colspan="4">No loans found.</td></tr>';
          } else {
            loansSnapshot.forEach(doc => {
              const data = doc.data();
              tableHtml += `
                <tr>
                  <td>${data.loanNumber}</td>
                  <td>₹${data.amount || 0}</td>
                  <td>₹${data.balance || 0}</td>
                  <td><button class="select-btn" onclick="selectLoan('${doc.id}', '${data.loanNumber}', ${data.amount || 0}, ${data.balance || 0}, ${data.interest || 0}, '${data.startDate || ''}')">Select</button></td>
                </tr>
              `;
              if (type === 'repay') repayLoanNumber.innerHTML += `<option value="${data.loanNumber}">${data.loanNumber}</option>`;
            });
          }
          tableHtml += '</tbody></table>';
          loanListEl.innerHTML = tableHtml;
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Error loading loans: ' + error.message;
      }
    }
  }

  window.selectLoan = async function(loanId, loanNumber, amount, balance, interest, startDate) {
    if (document.getElementById('editMemberNumber') && document.getElementById('editMemberNumber').value) {
      document.getElementById('editLoanNumber').value = loanNumber;
      document.getElementById('editLoanPrincipal').value = balance;
      document.getElementById('editLoanInterestDue').value = 0; // To be calculated
      document.getElementById('editLoanInterest').value = interest;
      showForm('editLoanForm');
    } else if (document.getElementById('repayMemberNumber') && document.getElementById('repayMemberNumber').value) {
      document.getElementById('repayLoanNumber').value = loanNumber;
      calculateInterest();
    }
  };

  window.saveLoan = async function() {
    const memberNumber = document.getElementById('createMemberNumber').value;
    const loanNumber = document.getElementById('createLoanNumber').value;
    const amount = parseFloat(document.getElementById('createLoanAmount').value) || 0;
    const interest = parseFloat(document.getElementById('createLoanInterest').value) || 0;
    const installments = parseInt(document.getElementById('createLoanInstallments').value) || 0;
    const startDate = document.getElementById('createLoanStartDate').value;
    const guarantor1 = document.getElementById('createLoanGuarantor1').value;
    const guarantor2 = document.getElementById('createLoanGuarantor2').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    if (!memberNumber || !loanNumber || !amount || !interest || !installments || !startDate || !guarantor1 || !guarantor2) {
      errorEl.innerText = 'All fields are required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        await setDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
          userId, loanNumber, amount, balance: amount, interest, installments, startDate,
          guarantors: [guarantor1, guarantor2], lastUpdated: new Date().toISOString()
        });
        alert('Loan created successfully!');
        showForm(null);
        await loadUserLoans('edit');
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error creating loan: ' + error.message;
    }
  };

  window.updateLoan = async function() {
    const memberNumber = document.getElementById('editMemberNumber').value;
    const loanNumber = document.getElementById('editLoanNumber').value;
    const principal = parseFloat(document.getElementById('editLoanPrincipal').value) || 0;
    const interestDue = parseFloat(document.getElementById('editLoanInterestDue').value) || 0;
    const interest = parseFloat(document.getElementById('editLoanInterest').value) || 0;
    const guarantor1 = document.getElementById('editLoanGuarantor1').value;
    const guarantor2 = document.getElementById('editLoanGuarantor2').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        await updateDoc(doc(db, 'loans', `${userId}_${loanNumber}`), {
          balance: principal, interestDue, interest, guarantors: [guarantor1, guarantor2], lastUpdated: new Date().toISOString()
        });
        alert('Loan updated successfully!');
        showForm(null);
        await loadUserLoans('edit');
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error updating loan: ' + error.message;
    }
  };

  async function calculateInterest() {
    const loanNumber = document.getElementById('repayLoanNumber').value;
    const memberNumber = document.getElementById('repayMemberNumber').value;
    const repayDate = document.getElementById('repayDate').value;
    if (loanNumber && memberNumber && repayDate) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const loanDoc = await getDoc(doc(db, 'loans', `${userId}_${loanNumber}`));
          if (loanDoc.exists()) {
            const data = loanDoc.data();
            const lastPaymentDate = await getLastPaymentDate(userId, loanNumber);
            const daysDiff = Math.floor((new Date(repayDate) - new Date(lastPaymentDate || data.startDate)) / (1000 * 60 * 60 * 24));
            const interestDue = (data.balance * data.interest * daysDiff) / (100 * 365);
            const installmentAmount = data.amount / data.installments;
            const principalDue = installmentAmount + (data.balance > data.amount ? data.balance - data.amount : 0);

            document.getElementById('repayPrincipal').value = principalDue.toFixed(2);
            document.getElementById('repayInterest').value = interestDue.toFixed(2);
            document.getElementById('repayInterestDue').value = interestDue.toFixed(2);
            document.getElementById('repayNewBalance').value = (data.balance - principalDue).toFixed(2);
          }
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Error calculating interest: ' + error.message;
      }
    }
  }

  async function getLastPaymentDate(userId, loanNumber) {
    const paymentsSnapshot = await getDocs(query(collection(db, 'payments'), where('userId', '==', userId), where('loanNumber', '==', loanNumber)));
    if (!paymentsSnapshot.empty) {
      return paymentsSnapshot.docs.sort((a, b) => new Date(b.data().timestamp) - new Date(a.data().timestamp))[0].data().timestamp;
    }
    return null;
  }

  async function loadLoanDetails() {
    const loanNumber = document.getElementById('repayLoanNumber').value;
    const memberNumber = document.getElementById('repayMemberNumber').value;
    if (loanNumber && memberNumber) {
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;
          const loanDoc = await getDoc(doc(db, 'loans', `${userId}_${loanNumber}`));
          if (loanDoc.exists()) {
            const data = loanDoc.data();
            const lastPaymentDate = await getLastPaymentDate(userId, loanNumber);
            const daysDiff = Math.floor((new Date() - new Date(lastPaymentDate || data.startDate)) / (1000 * 60 * 60 * 24));
            const interestDue = (data.balance * data.interest * daysDiff) / (100 * 365);
            const installmentAmount = data.amount / data.installments;
            const principalDue = installmentAmount + (data.balance > data.amount ? data.balance - data.amount : 0);

            document.getElementById('repayPrincipal').value = principalDue.toFixed(2);
            document.getElementById('repayInterest').value = interestDue.toFixed(2);
            document.getElementById('repayInterestDue').value = interestDue.toFixed(2);
            document.getElementById('repayNewBalance').value = (data.balance - principalDue).toFixed(2);
          }
        }
      } catch (error) {
        document.getElementById('error').innerText = 'Error loading loan details: ' + error.message;
      }
    }
  }

  window.addRepayment = async function() {
    const memberNumber = document.getElementById('repayMemberNumber').value;
    const loanNumber = document.getElementById('repayLoanNumber').value;
    const date = document.getElementById('repayDate').value;
    const principal = parseFloat(document.getElementById('repayPrincipal').value) || 0;
    const interest = parseFloat(document.getElementById('repayInterest').value) || 0;
    const newBalance = parseFloat(document.getElementById('repayNewBalance').value) || 0;
    const interestDue = parseFloat(document.getElementById('repayInterestDue').value) || 0;
    const receiptNumber = document.getElementById('repayReceiptNumber').value;
    const errorEl = document.getElementById('error');

    if (!auth.currentUser || !(await getDoc(doc(db, 'users', auth.currentUser.uid))).data().isAdmin) {
      errorEl.innerText = 'Admin access required!';
      return;
    }

    try {
      const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
      if (!usersSnapshot.empty) {
        const userDoc = usersSnapshot.docs[0];
        const userId = userDoc.id;
        const loanDoc = await getDoc(doc(db, 'loans', `${userId}_${loanNumber}`));
        if (loanDoc.exists()) {
          await updateDoc(doc(db, 'loans', `${userId}_${loanNumber}`), { balance: newBalance, interestDue: 0, lastUpdated: new Date().toISOString() });
          await setDoc(doc(db, 'payments', `${userId}_${loanNumber}_${Date.now()}`), {
            userId, loanNumber, date, principal, interest, newBalance, interestDue, receiptNumber, timestamp: new Date().toISOString()
          });
          alert('Repayment added successfully!');
          showForm(null);
          loadLoanDetails();
          const paymentListEl = document.getElementById('paymentList');
          paymentListEl.innerHTML = await generatePaymentStatement(userId, loanNumber);
        } else {
          errorEl.innerText = 'Loan not found!';
        }
      } else {
        errorEl.innerText = 'User not found with this Member Number!';
      }
    } catch (error) {
      errorEl.innerText = 'Error adding repayment: ' + error.message;
    }
  };

  async function generatePaymentStatement(userId, loanNumber) {
    const paymentsSnapshot = await getDocs(query(collection(db, 'payments'), where('userId', '==', userId), where('loanNumber', '==', loanNumber)));
    let tableHtml = '<h3>Payment Statement</h3><table class="payment-table"><thead><tr><th>Date</th><th>Principal</th><th>Interest</th><th>New Balance</th><th>Receipt #</th></tr></thead><tbody>';
    if (paymentsSnapshot.empty) {
      tableHtml += '<tr><td colspan="5">No payments found.</td></tr>';
    } else {
      paymentsSnapshot.forEach(doc => {
        const data = doc.data();
        tableHtml += `
          <tr>
            <td>${data.date || 'N/A'}</td>
            <td>₹${data.principal || 0}</td>
            <td>₹${data.interest || 0}</td>
            <td>₹${data.newBalance || 0}</td>
            <td>${data.receiptNumber || 'N/A'}</td>
          </tr>
        `;
      });
    }
    tableHtml += '</tbody></table>';
    return tableHtml;
  }

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      await signOut(auth);
      window.location.href = 'index.html';
    } catch (error) {
      document.getElementById('error').innerText = 'Error logging out: ' + error.message;
    }
  });
</script>
</body>
</html>